<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>台灣恐怖地圖</title>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: Arial, sans-serif;
    }
    #sidebar {
      width: 250px;
      overflow-y: auto;
      background: #f5f5f5;
      padding: 10px;
      border-right: 1px solid #ccc;
    }
    #map {
      flex: 1;
    }
    #postDisplay {
      position: fixed;
      bottom: 0;
      left: 250px;
      right: 0;
      background: white;
      border-top: 2px solid #ccc;
      max-height: 30%;
      overflow-y: auto;
      padding: 10px;
      display: none; /* 預設隱藏 */
    }
    .postCard {
      margin-bottom: 10px;
    }
    .postCard h2 {
      margin: 0 0 5px 0;
    }
    #searchBox {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
    }
    h3 {
      margin-top: 15px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 3px;
    }
    ul {
      list-style: none;
      padding-left: 10px;
    }
    li a {
      display: block;
      padding: 2px 0;
      text-decoration: none;
      color: #333;
    }
    li a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="sidebar"></div>
  <div id="map"></div>
  <div id="postDisplay"></div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDGoEL8NEw0Vt0X1SJbrFpi5WTI6zPwCoM"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCK8DBDjoj5pZg3vaGtktVyUuWOPUxDumU",
      authDomain: "taiwan-horror-map-e257d.firebaseapp.com",
      projectId: "taiwan-horror-map-e257d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let map;
    let markers = [];
    let allPosts = [];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 23.6978, lng: 120.9605 },
        zoom: 7
      });
      loadPosts();
    }

    async function loadPosts() {
      const snap = await getDocs(collection(db, "posts"));
      let groups = {};
      allPosts = [];

      snap.forEach(doc => {
        const data = doc.data();
        if (data.createdAt && data.createdAt.toDate) {
          data.createdAt = data.createdAt.toDate();
        }
        let region = data.locationName || "未分類";
        if (!groups[region]) groups[region] = [];
        groups[region].push({ id: doc.id, ...data });
        allPosts.push({ id: doc.id, ...data });
      });

      renderSidebar(groups);
      updateMarkersByBounds();
      map.addListener("idle", updateMarkersByBounds);
    }

    function renderSidebar(groups) {
      const sidebar = document.getElementById("sidebar");
      sidebar.innerHTML = `
        <input type="text" id="searchBox" placeholder="搜尋文章...">
        <button onclick="window.location.href='submit.html'">✍️ 我要投稿</button>
      `;

      for (let region in groups) {
        let h3 = document.createElement("h3");
        h3.innerText = region;
        sidebar.appendChild(h3);

        let ul = document.createElement("ul");
        groups[region].forEach(post => {
          let li = document.createElement("li");
          let a = document.createElement("a");
          a.innerText = post.title;
          a.href = "#";
          a.onclick = () => showPostBelow(post);
          li.appendChild(a);
          ul.appendChild(li);
        });
        sidebar.appendChild(ul);
      }

      document.getElementById("searchBox").addEventListener("input", e => {
        const keyword = e.target.value.toLowerCase();
        const links = sidebar.querySelectorAll("a");
        links.forEach(link => {
          link.style.display = link.innerText.toLowerCase().includes(keyword) ? "block" : "none";
        });
      });
    }

    function showPostBelow(post) {
      const container = document.getElementById("postDisplay");
      container.innerHTML = `
        <div class="postCard">
          <h2>${post.title}</h2>
          <p>${post.content}</p>
          <p><b>地點：</b>${post.locationName}</p>
        </div>
      `;
      container.style.display = "block"; // 顯示欄位

      if (post.coordinates) {
        let pos = {
          lat: post.coordinates.latitude,
          lng: post.coordinates.longitude
        };
        map.setCenter(pos);
        map.setZoom(14);
      }
    }

    function updateMarkersByBounds() {
      if (!map.getBounds()) return;
      clearMarkers();

      const bounds = map.getBounds();
      allPosts.forEach(post => {
        if (post.coordinates) {
          let pos = new google.maps.LatLng(post.coordinates.latitude, post.coordinates.longitude);
          if (bounds.contains(pos)) {
            addMarker(post);
          }
        }
      });
    }

    function addMarker(post) {
      let pos = {
        lat: post.coordinates.latitude,
        lng: post.coordinates.longitude
      };
      let marker = new google.maps.Marker({
        position: pos,
        map: map,
        title: post.title
      });
      marker.addListener("click", () => {
        showPostBelow(post);
      });
      markers.push(marker);
    }

    function clearMarkers() {
      markers.forEach(m => m.setMap(null));
      markers = [];
    }

    window.initMap = initMap;
  </script>
</body>
</html>
