<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å°ç£ææ€–åœ°åœ–</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#111; color:#eee; }
    h1 { text-align:center; padding:15px; background:#222; color:#ff4444; margin:0; cursor:pointer; }
    h2 { text-align:center; margin:5px 0 15px; font-weight:normal; color:#aaa; }

    #container { display:flex; height:60vh; }
    #sidebar {
      width:250px; background:#222; overflow-y:auto; padding:10px;
    }
    #sidebar h3 { margin:10px 0; color:#66ccff; }
    #sidebar ul { list-style:none; padding:0; }
    #sidebar li { margin:5px 0; }
    #sidebar a { color:#eee; text-decoration:none; display:block; padding:5px; border-radius:6px; }
    #sidebar a:hover { background:#333; }

    #map { flex:1; }

    #searchBox { width:100%; padding:6px; margin:8px 0; border:none; border-radius:6px; }

    #postArea { padding:20px; max-width:900px; margin:auto; }

    .postCard { background:#222; margin-bottom:15px; padding:15px; border-radius:10px; }
    .postCard h3 { margin-top:0; color:#ff6666; }

    footer { margin-top:30px; padding:20px; background:#222; text-align:center; font-size:14px; color:#bbb; }

    #backToTop {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #ff4444;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:0 4px 8px rgba(0,0,0,0.4);
    }
    #backToTop img { width:24px; height:24px; }

    .breadcrumb {
      margin: 10px 0;
      color: #888;
    }
    .breadcrumb a {
      color: #66ccff;
      text-decoration: none;
    }
    .breadcrumb a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- å‹•æ…‹è¼‰å…¥ header -->
  <div id="header"></div>

  <div id="container">
    <div id="sidebar">
      <input type="text" id="searchBox" placeholder="æœå°‹æ–‡ç« ...">
      <button onclick="window.location.href='submit.html'">âœï¸ æˆ‘è¦æŠ•ç¨¿</button>
      <p>ğŸ“– æ–‡ç« æ¸…å–®è¼‰å…¥ä¸­...</p>
    </div>
    <div id="map"></div>
  </div>

  <!-- æ–‡ç« å€å¡Š -->
  <div id="postArea">
    <!-- æ¸…å–®åˆ—è¡¨ -->
    <div id="postListView">
      <h2 id="latest">æœ€æ–°æ–‡ç« </h2>
      <div id="latestPosts"></div>
    </div>

<!-- å–®ç¯‡æ–‡ç« è©³ç´° -->
<div id="postDetailView" style="display:none;">
  <div class="breadcrumb" id="postBreadcrumb">
    <a href="#" onclick="goBack()">æœ€æ–°æ–‡ç« </a> &gt; 
    <span id="currentPostTitle">æ–‡ç« æ¨™é¡Œ</span>
  </div>
  <div id="postDetailContent"></div>
</div>


  <!-- å›åˆ°é ‚ç«¯ -->
  <button id="backToTop" onclick="window.scrollTo({top:0, behavior:'smooth'});">
    <img src="https://cdn-icons-png.flaticon.com/512/892/892692.png" alt="å›åˆ°é ‚ç«¯">
  </button>

  <!-- å‹•æ…‹è¼‰å…¥ footer -->
  <div id="footer"></div>

  <!-- Google Maps -->
<script>
  let map;
  let markers = [];
  let posts = [];

  // åˆå§‹åŒ– Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCK8DBDjoj5pZg3vaGtktVyUuWOPUxDumU",
    authDomain: "taiwan-horror-map-e257d.firebaseapp.com",
    projectId: "taiwan-horror-map-e257d",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // åˆå§‹åŒ–åœ°åœ–
  function initMap() {
    const taiwan = { lat: 23.6978, lng: 120.9605 };
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 7,
      center: taiwan,
    });

    // åœ°åœ– idle å¾Œæ›´æ–°ç¯„åœå…§çš„æ¨™è¨˜
    map.addListener("idle", () => {
      updateMarkersByBounds();
    });

    // ç­‰åœ°åœ–æº–å‚™å¥½æ‰è¼‰æ–‡ç« 
    loadPosts();
  }

  // è¼‰å…¥æ–‡ç« 
  function loadPosts() {
    db.collection("articles")
      .get()
      .then((querySnapshot) => {
        posts = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          posts.push({
            id: doc.id,
            title: data.title || "ç„¡æ¨™é¡Œ",
            content: data.content || "",
            lat: data.coordinates?.[0],
            lng: data.coordinates?.[1],
            createdAt: data.createdAt || null,
          });
        });

        // æŒ‰æ—¥æœŸæ’åºï¼ˆè™•ç† createdAt ç¼ºå¤±ï¼‰
        posts.sort((a, b) => {
          let dateA = a.createdAt ? new Date(a.createdAt) : 0;
          let dateB = b.createdAt ? new Date(b.createdAt) : 0;
          return dateB - dateA;
        });

        populateSidebar();
        updateMarkersByBounds(); // è¼‰å…¥å®Œæ–‡ç« å°±é¡¯ç¤ºæ¨™è¨˜
      });
  }

  // æ›´æ–°ç¯„åœå…§çš„æ¨™è¨˜
  function updateMarkersByBounds() {
    clearMarkers();
    const bounds = map.getBounds();
    posts.forEach((post) => {
      if (bounds && post.lat && post.lng) {
        const position = new google.maps.LatLng(post.lat, post.lng);
        if (bounds.contains(position)) {
          const marker = new google.maps.Marker({
            position,
            map,
            title: post.title,
          });
          marker.addListener("click", () => {
            showPost(post.id);
          });
          markers.push(marker);
        }
      }
    });
  }

  // æ¸…é™¤æ‰€æœ‰æ¨™è¨˜
  function clearMarkers() {
    markers.forEach((marker) => marker.setMap(null));
    markers = [];
  }

  // å¡«å……å·¦å´æ–‡ç« åˆ—è¡¨
  function populateSidebar() {
    const sidebar = document.getElementById("sidebar");
    const ul = document.createElement("ul");
    posts.forEach((post) => {
      const li = document.createElement("li");
      const a = document.createElement("a");
      a.textContent = post.title;
      a.href = "#";
      a.addEventListener("click", (e) => {
        e.preventDefault();
        showPost(post.id);
      });
      li.appendChild(a);
      ul.appendChild(li);
    });
    sidebar.appendChild(ul);
  }

  // é¡¯ç¤ºå–®ç¯‡æ–‡ç« 
  function showPost(id) {
    const post = posts.find((p) => p.id === id);
    if (!post) return;

    const contentArea = document.getElementById("post-content");
    contentArea.innerHTML = `<h2>${post.title}</h2><p>${post.content}</p>`;
    document.getElementById("post-detail").style.display = "block";
  }

  // æœå°‹æ–‡ç« 
  function searchArticles() {
    const keyword = document.getElementById("search").value.toLowerCase();
    const sidebar = document.getElementById("sidebar");
    const links = sidebar.querySelectorAll("ul a"); // åªæŠ“æ–‡ç« åˆ—è¡¨çš„é€£çµ
    links.forEach((a) => {
      const text = a.textContent.toLowerCase();
      a.parentElement.style.display = text.includes(keyword) ? "" : "none";
    });
  }
</script>
</body>
</html>
