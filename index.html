<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>台灣恐怖地圖</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#111; color:#eee; }
    h1 { text-align:center; padding:15px; background:#222; color:#ff4444; margin:0; cursor:pointer; }
    h2 { text-align:center; margin:5px 0 15px; font-weight:normal; color:#aaa; }

    #container { display:flex; height:60vh; }
    #sidebar {
      width:250px; background:#222; overflow-y:auto; padding:10px;
    }
    #sidebar h3 { margin:10px 0; color:#66ccff; }
    #sidebar ul { list-style:none; padding:0; }
    #sidebar li { margin:5px 0; }
    #sidebar a { color:#eee; text-decoration:none; display:block; padding:5px; border-radius:6px; }
    #sidebar a:hover { background:#333; }

    #map { flex:1; }

    #searchBox { width:100%; padding:6px; margin:8px 0; border:none; border-radius:6px; }

    #postArea { padding:20px; max-width:900px; margin:auto; }

    .postCard { background:#222; margin-bottom:15px; padding:15px; border-radius:10px; }
    .postCard h3 { margin-top:0; color:#ff6666; }

    footer { margin-top:30px; padding:20px; background:#222; text-align:center; font-size:14px; color:#bbb; }

    #backToTop {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #ff4444;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:0 4px 8px rgba(0,0,0,0.4);
    }
    #backToTop img { width:24px; height:24px; }

    .breadcrumb {
      margin: 10px 0;
      color: #888;
    }
    .breadcrumb a {
      color: #66ccff;
      text-decoration: none;
    }
    .breadcrumb a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- 動態載入 header -->
  <div id="header"></div>

  <div id="container">
    <div id="sidebar">
      <input type="text" id="searchBox" placeholder="搜尋文章...">
      <button onclick="window.location.href='submit.html'">✍️ 我要投稿</button>
      <p>📖 文章清單載入中...</p>
    </div>
    <div id="map"></div>
  </div>

  <!-- 文章區塊 -->
  <div id="postArea">
    <!-- 清單列表 -->
    <div id="postListView">
      <h2 id="latest">最新文章</h2>
      <div id="latestPosts"></div>
    </div>

<!-- 單篇文章詳細 -->
<div id="postDetailView" style="display:none;">
  <div class="breadcrumb" id="postBreadcrumb">
    <a href="#" onclick="goBack()">最新文章</a> &gt; 
    <span id="currentPostTitle">文章標題</span>
  </div>
  <div id="postDetailContent"></div>
</div>


  <!-- 回到頂端 -->
  <button id="backToTop" onclick="window.scrollTo({top:0, behavior:'smooth'});">
    <img src="https://cdn-icons-png.flaticon.com/512/892/892692.png" alt="回到頂端">
  </button>

  <!-- 動態載入 footer -->
  <div id="footer"></div>

  <!-- Google Maps -->
<script>
  let map;
  let markers = [];
  let posts = [];

  // 初始化 Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCK8DBDjoj5pZg3vaGtktVyUuWOPUxDumU",
    authDomain: "taiwan-horror-map-e257d.firebaseapp.com",
    projectId: "taiwan-horror-map-e257d",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // 初始化地圖
  function initMap() {
    const taiwan = { lat: 23.6978, lng: 120.9605 };
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 7,
      center: taiwan,
    });

    // 地圖 idle 後更新範圍內的標記
    map.addListener("idle", () => {
      updateMarkersByBounds();
    });

    // 等地圖準備好才載文章
    loadPosts();
  }

  // 載入文章
  function loadPosts() {
    db.collection("articles")
      .get()
      .then((querySnapshot) => {
        posts = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          posts.push({
            id: doc.id,
            title: data.title || "無標題",
            content: data.content || "",
            lat: data.coordinates?.[0],
            lng: data.coordinates?.[1],
            createdAt: data.createdAt || null,
          });
        });

        // 按日期排序（處理 createdAt 缺失）
        posts.sort((a, b) => {
          let dateA = a.createdAt ? new Date(a.createdAt) : 0;
          let dateB = b.createdAt ? new Date(b.createdAt) : 0;
          return dateB - dateA;
        });

        populateSidebar();
        updateMarkersByBounds(); // 載入完文章就顯示標記
      });
  }

  // 更新範圍內的標記
  function updateMarkersByBounds() {
    clearMarkers();
    const bounds = map.getBounds();
    posts.forEach((post) => {
      if (bounds && post.lat && post.lng) {
        const position = new google.maps.LatLng(post.lat, post.lng);
        if (bounds.contains(position)) {
          const marker = new google.maps.Marker({
            position,
            map,
            title: post.title,
          });
          marker.addListener("click", () => {
            showPost(post.id);
          });
          markers.push(marker);
        }
      }
    });
  }

  // 清除所有標記
  function clearMarkers() {
    markers.forEach((marker) => marker.setMap(null));
    markers = [];
  }

  // 填充左側文章列表
  function populateSidebar() {
    const sidebar = document.getElementById("sidebar");
    const ul = document.createElement("ul");
    posts.forEach((post) => {
      const li = document.createElement("li");
      const a = document.createElement("a");
      a.textContent = post.title;
      a.href = "#";
      a.addEventListener("click", (e) => {
        e.preventDefault();
        showPost(post.id);
      });
      li.appendChild(a);
      ul.appendChild(li);
    });
    sidebar.appendChild(ul);
  }

  // 顯示單篇文章
  function showPost(id) {
    const post = posts.find((p) => p.id === id);
    if (!post) return;

    const contentArea = document.getElementById("post-content");
    contentArea.innerHTML = `<h2>${post.title}</h2><p>${post.content}</p>`;
    document.getElementById("post-detail").style.display = "block";
  }

  // 搜尋文章
  function searchArticles() {
    const keyword = document.getElementById("search").value.toLowerCase();
    const sidebar = document.getElementById("sidebar");
    const links = sidebar.querySelectorAll("ul a"); // 只抓文章列表的連結
    links.forEach((a) => {
      const text = a.textContent.toLowerCase();
      a.parentElement.style.display = text.includes(keyword) ? "" : "none";
    });
  }
</script>
</body>
</html>
