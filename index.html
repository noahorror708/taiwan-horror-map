<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>台灣恐怖地圖</title>
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#111; color:#eee; }
    h1 { text-align:center; padding:15px; background:#222; color:#ff4444; margin:0; }
    #description { text-align:center; padding:10px; background:#1a1a1a; font-size:14px; color:#ccc; }
    #map { height:50vh; }
    #content { padding:15px; }
    .post { margin-bottom:20px; padding:15px; background:#222; border-radius:8px; }
    .post h2 { margin:0 0 10px; color:#66ccff; }
    /* 抽屜 */
    #drawer {
      height:100%; width:0; position:fixed; top:0; left:0;
      background:#222; overflow-x:hidden; transition:0.3s; padding-top:60px;
      display:flex; flex-direction:column;
    }
    #drawer a { padding:8px 16px; text-decoration:none; color:#eee; display:block; }
    #drawer a:hover { background:#333; }
    #openDrawerBtn {
      position:fixed; top:20px; left:20px; font-size:20px; background:#ff4444; color:#fff;
      border:none; border-radius:50%; width:40px; height:40px; cursor:pointer;
    }
    #searchBox {
      margin:10px; padding:8px; border-radius:6px; border:none; width:80%;
      font-size:14px;
    }
    footer { text-align:center; padding:15px; background:#222; color:#aaa; font-size:12px; }
  </style>
</head>
<body>
  <h1>台灣恐怖地圖</h1>
  <div id="description">這裡蒐集全台靈異故事與地點，點擊左側清單即可查看。</div>

  <!-- 抽屜按鈕 -->
  <button id="openDrawerBtn">☰</button>
  <div id="drawer">
    <a href="javascript:void(0)" onclick="closeDrawer()">✖ 關閉</a>
    <div id="regionList">載入中...</div>
    <input id="searchBox" type="text" placeholder="🔍 搜尋文章...">
  </div>

  <!-- 上半部地圖 -->
  <div id="map"></div>

  <!-- 下半部文章 -->
  <div id="content"></div>

  <!-- 底部 -->
  <footer>
    聯絡信箱：xxx@gmail.com ｜ 本網站故事內容純屬投稿者經驗分享，僅供參考，不代表真實發生。
  </footer>

  <!-- Google Maps -->
  <script>
    let map;
    function initMap() {
      const taiwan = { lat: 23.6978, lng: 120.9605 };
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 7, center: taiwan,
      });
    }
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_FIREBASE_KEY",
      authDomain: "xxx.firebaseapp.com",
      projectId: "xxx",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allPosts = []; // 存所有文章

    // 載入文章
    async function loadPosts() {
      const querySnapshot = await getDocs(collection(db, "posts"));
      let groups = {};
      let contentDiv = document.getElementById("content");
      contentDiv.innerHTML = "";
      allPosts = []; // 先清空

      querySnapshot.forEach((doc) => {
        let data = doc.data();
        let region = data.locationName || "未分類";
        if (!groups[region]) groups[region] = [];
        groups[region].push(data);
        allPosts.push(data);

        // 顯示文章（不顯示作者）
        let div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `<h2>${data.title}</h2><p>${data.content}</p><p><b>地點：</b>${region}</p>`;
        contentDiv.appendChild(div);
      });

      renderDrawer(groups);
    }

    // 抽屜清單
    function renderDrawer(groups) {
      const regionList = document.getElementById("regionList");
      regionList.innerHTML = "";
      for (let region in groups) {
        let h3 = document.createElement("h3");
        h3.style.color = "#66ccff";
        h3.style.padding = "5px 15px";
        h3.innerText = region;
        regionList.appendChild(h3);

        groups[region].forEach(post => {
          let a = document.createElement("a");
          a.innerText = post.title;
          a.href = "#";
          a.onclick = () => {
            if (post.coordinates) {
              let [lat, lng] = post.coordinates.split(",").map(Number);
              let pos = { lat, lng };
              map.setCenter(pos);
              map.setZoom(14);
              new google.maps.Marker({ position: pos, map: map, title: post.title });
              window.scrollTo({ top:0, behavior:"smooth" });
            }
          };
          regionList.appendChild(a);
        });
      }
    }

    // 搜尋功能
    document.getElementById("searchBox").addEventListener("input", function() {
      const keyword = this.value.toLowerCase();
      const contentDiv = document.getElementById("content");
      contentDiv.innerHTML = "";

      allPosts
        .filter(p => p.title.toLowerCase().includes(keyword) || p.content.toLowerCase().includes(keyword))
        .forEach(p => {
          let div = document.createElement("div");
          div.className = "post";
          div.innerHTML = `<h2>${p.title}</h2><p>${p.content}</p><p><b>地點：</b>${p.locationName || "未分類"}</p>`;
          contentDiv.appendChild(div);
        });
    });

    // 抽屜控制
    function openDrawer() { document.getElementById("drawer").style.width = "250px"; }
    function closeDrawer() { document.getElementById("drawer").style.width = "0"; }
    document.getElementById("openDrawerBtn").onclick = openDrawer;

    loadPosts();
  </script>
</body>
</html>
