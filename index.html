<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>台灣恐怖地圖</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    /* 漢堡按鈕 */
    #menu-toggle {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1100;
      background: white;
      border: none;
      font-size: 24px;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    /* 抽屜 */
    #city-drawer {
      position: fixed;
      top: 0;
      left: 0;
      width: 260px;
      height: 100%;
      background: white;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
      padding: 10px;
    }
    #city-drawer.open {
      transform: translateX(0);
    }
    #city-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #city-list > li {
      margin-bottom: 8px;
      font-weight: bold;
    }
    #city-list ul {
      list-style: none;
      padding-left: 16px;
    }
    #city-list a {
      color: black;
      text-decoration: none;
    }
    #map {
      flex: 1;
    }

    /* 桌機時固定抽屜 */
    @media (min-width: 768px) {
      #city-drawer {
        transform: translateX(0);
        position: relative;
        box-shadow: none;
      }
      #menu-toggle {
        display: none;
      }
      body {
        flex-direction: row;
      }
      #map {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <button id="menu-toggle">☰</button>
  <div id="city-drawer">
    <ul id="city-list"></ul>
  </div>
  <div id="map"></div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // 初始化 Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCK8DBDjoj5pZg3vaGtktVyUuWOPUxDumU",
        authDomain: "taiwan-horror-map-e257d.firebaseapp.com",
        projectId: "taiwan-horror-map-e257d",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Leaflet 地圖
      const map = L.map("map").setView([23.7, 121], 7);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
      }).addTo(map);

      // 漢堡抽屜功能
      const menuToggle = document.getElementById("menu-toggle");
      const cityDrawer = document.getElementById("city-drawer");
      menuToggle.addEventListener("click", () => {
        cityDrawer.classList.toggle("open");
        setTimeout(() => map.invalidateSize(), 300);
      });

      // 縣市排序
      const cityOrder = [
        "臺北市", "新北市", "基隆市", "新竹市", "桃園市", "新竹縣", "宜蘭縣",
        "臺中市", "苗栗縣", "彰化縣", "南投縣", "雲林縣",
        "高雄市", "臺南市", "嘉義市", "嘉義縣", "屏東縣", "澎湖縣",
        "花蓮縣", "臺東縣", "金門縣", "連江縣"
      ];

      // 讀取 Firestore
      db.collection("articles").orderBy("timestamp", "desc").get().then(snapshot => {
        const cityMap = {};

        snapshot.forEach(doc => {
          const data = doc.data();

          // 地圖標記
          if (data.coordinates) {
            const marker = L.marker(data.coordinates).addTo(map);
            marker.bindPopup(`<b>${data.title}</b><br>${data.locationName || ""}`);
          }

          // 城市分類
          if (data.locationName) {
            const city = cityOrder.find(c => data.locationName.startsWith(c));
            if (city) {
              if (!cityMap[city]) cityMap[city] = [];
              cityMap[city].push({ title: data.title, id: doc.id });
            }
          }
        });

        // 抽屜城市清單
        const cityListEl = document.getElementById("city-list");
        cityOrder.forEach(city => {
          if (cityMap[city]) {
            const li = document.createElement("li");
            li.textContent = city;
            const ul = document.createElement("ul");
            cityMap[city].forEach(article => {
              const ali = document.createElement("li");
              const a = document.createElement("a");
              a.textContent = article.title;
              a.href = `article.html?id=${article.id}`;
              ali.appendChild(a);
              ul.appendChild(ali);
            });
            li.appendChild(ul);
            cityListEl.appendChild(li);
          }
        });
      });
    });
  </script>
</body>
</html>
