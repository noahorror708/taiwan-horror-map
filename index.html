<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>台灣恐怖地圖</title>
    <style>
      body { display: flex; margin: 0; font-family: sans-serif; }
      #sidebar { width: 300px; height: 100vh; overflow-y: auto; border-right: 1px solid #ccc; padding: 10px; }
      #map { flex: 1; height: 100vh; }
      .postItem { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; }
      .postItem:hover { background: #f5f5f5; }
      #postDetailView { width: 100%; padding: 10px; border-top: 1px solid #ccc; }
      .postCard { border: 1px solid #ccc; padding: 10px; background: #fff; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  </head>
  <body>
    <div id="sidebar">
      <h2>文章列表</h2>
      <div id="postList"></div>
    </div>
    <div style="flex: 1; display: flex; flex-direction: column;">
      <div id="map"></div>
      <div id="postDetailView" style="display:none;">
        <div id="postDetailContent"></div>
      </div>
    </div>

    <script>
      // Firestore 初始化
      const firebaseConfig = {
        apiKey: "你的 API key",
        authDomain: "xxx.firebaseapp.com",
        projectId: "xxx",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      let map;
      let markers = [];
      let posts = [];

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 23.6978, lng: 120.9605 },
          zoom: 7,
        });

        loadPosts();
        map.addListener("idle", updateMarkersByBounds);
      }

      async function loadPosts() {
        const snapshot = await db.collection("posts").get();
        posts = snapshot.docs.map(doc => doc.data());
        renderSidebar(posts);
        updateMarkersByBounds();
      }

      function renderSidebar(posts) {
        const listDiv = document.getElementById("postList");
        listDiv.innerHTML = "";
        posts.forEach(post => {
          const item = document.createElement("div");
          item.className = "postItem";
          item.innerText = post.title;
          item.onclick = () => showPost(post);
          listDiv.appendChild(item);
        });
      }

      function updateMarkersByBounds() {
        markers.forEach(m => m.setMap(null));
        markers = [];

        const bounds = map.getBounds();
        if (!bounds) return;

        const filtered = posts.filter(p => {
          if (!p.coordinates) return false;
          const pos = new google.maps.LatLng(p.coordinates.latitude, p.coordinates.longitude);
          return bounds.contains(pos);
        });

        filtered.forEach(post => {
          const marker = new google.maps.Marker({
            position: { lat: post.coordinates.latitude, lng: post.coordinates.longitude },
            map,
            title: post.title,
          });
          marker.addListener("click", () => showPost(post));
          markers.push(marker);
        });
      }

      function showPost(post) {
        document.getElementById("postDetailView").style.display = "block";
        const detail = document.getElementById("postDetailContent");
        detail.innerHTML = `
          <div class="postCard">
            <h3>${post.title}</h3>
            <p>${post.content || "（無內容）"}</p>
            <p><b>地點：</b>${post.locationName || "未提供"}</p>
          </div>
        `;

        if (post.coordinates) {
          map.setCenter({ lat: post.coordinates.latitude, lng: post.coordinates.longitude });
          map.setZoom(14);
        }
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=你的GoogleMapsAPIKey&callback=initMap" async defer></script>
  </body>
</html>
