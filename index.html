<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å°ç£ææ€–åœ°åœ–</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#111; color:#eee; }
    h1 { text-align:center; padding:15px; background:#222; color:#ff4444; margin:0; cursor:pointer; }
    h2 { text-align:center; margin:5px 0 15px; font-weight:normal; color:#aaa; }

    #container { display:flex; height:60vh; }
    #sidebar {
      width:250px; background:#222; overflow-y:auto; padding:10px;
    }
    #sidebar h3 { margin:10px 0; color:#66ccff; }
    #sidebar ul { list-style:none; padding:0; }
    #sidebar li { margin:5px 0; }
    #sidebar a { color:#eee; text-decoration:none; display:block; padding:5px; border-radius:6px; }
    #sidebar a:hover { background:#333; }

    #map { flex:1; }

    #searchBox { width:100%; padding:6px; margin:8px 0; border:none; border-radius:6px; }

    #postArea { padding:20px; max-width:900px; margin:auto; }

    .postCard { background:#222; margin-bottom:15px; padding:15px; border-radius:10px; }
    .postCard h3 { margin-top:0; color:#ff6666; }

    footer { margin-top:30px; padding:20px; background:#222; text-align:center; font-size:14px; color:#bbb; }

    #backToTop {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #ff4444;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:0 4px 8px rgba(0,0,0,0.4);
    }
    #backToTop img { width:24px; height:24px; }

    .breadcrumb {
      margin: 10px 0;
      color: #888;
    }
    .breadcrumb a {
      color: #66ccff;
      text-decoration: none;
    }
    .breadcrumb a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- å‹•æ…‹è¼‰å…¥ header -->
  <div id="header"></div>

  <div id="container">
    <div id="sidebar">
      <input type="text" id="searchBox" placeholder="æœå°‹æ–‡ç« ...">
      <button onclick="window.location.href='submit.html'">âœï¸ æˆ‘è¦æŠ•ç¨¿</button>
      <p>ğŸ“– æ–‡ç« æ¸…å–®è¼‰å…¥ä¸­...</p>
    </div>
    <div id="map"></div>
  </div>

  <!-- æ–‡ç« å€å¡Š -->
  <div id="postArea">
    <!-- æ¸…å–®åˆ—è¡¨ -->
    <div id="postListView">
      <h2 id="latest">æœ€æ–°æ–‡ç« </h2>
      <div id="latestPosts"></div>
    </div>

    <!-- å–®ç¯‡æ–‡ç« è©³ç´° -->
    <div id="postDetailView" style="display:none;">
      <div class="breadcrumb" id="postBreadcrumb">
        <a href="#" onclick="goBack()">æœ€æ–°æ–‡ç« </a> &gt; <span id="currentPostTitle">æ–‡ç« æ¨™é¡Œ</span>
      </div>
      <div id="postDetailContent"></div>
    </div>
  </div>

  <!-- å›åˆ°é ‚ç«¯ -->
  <button id="backToTop" onclick="window.scrollTo({top:0, behavior:'smooth'});">
    <img src="https://cdn-icons-png.flaticon.com/512/892/892692.png" alt="å›åˆ°é ‚ç«¯">
  </button>

  <!-- å‹•æ…‹è¼‰å…¥ footer -->
  <div id="footer"></div>

  <!-- Google Maps -->
  <script>
    let map;
    function initMap() {
      const taiwan = { lat: 23.6978, lng: 120.9605 };
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 7,
        center: taiwan,
      });
    }
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDGoEL8NEw0Vt0X1SJbrFpi5WTI6zPwCoM&callback=initMap">
  </script>

  <!-- è¼‰å…¥ header & footer -->
  <script>
    async function loadHTML(id, file) {
      const res = await fetch(file);
      const text = await res.text();
      document.getElementById(id).innerHTML = text;
    }
    loadHTML("header", "header.html");
    loadHTML("footer", "footer.html");
  </script>

  <!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCK8DBDjoj5pZg3vaGtktVyUuWOPUxDumU",
    authDomain: "taiwan-horror-map-e257d.firebaseapp.com",
    projectId: "taiwan-horror-map-e257d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let markers = [];
  let allPosts = [];

  async function loadPosts() {
    const snap = await getDocs(collection(db, "posts"));
    let groups = {};

    allPosts = []; // é‡è¨­æ–‡ç« æ¸…å–®

    snap.forEach(doc => {
      const data = doc.data();

      if (data.createdAt && data.createdAt.toDate) {
        data.createdAt = data.createdAt.toDate();
      }

      let region = data.locationName || "æœªåˆ†é¡";
      if (!groups[region]) groups[region] = [];
      groups[region].push({ id: doc.id, ...data });
      allPosts.push({ id: doc.id, ...data });
    });

    renderSidebar(groups);
    renderLatest(allPosts);

    // åˆå§‹åŒ–æ™‚å…ˆé¡¯ç¤ºç¯„åœå…§çš„æ¨™è¨˜
    updateMarkersByBounds();

    // åœ°åœ–ç§»å‹•æˆ–ç¸®æ”¾çµæŸå¾Œæ›´æ–°æ¨™è¨˜
    map.addListener("idle", updateMarkersByBounds);
  }

  function renderSidebar(groups) {
    const sidebar = document.getElementById("sidebar");
    sidebar.innerHTML = `
      <input type="text" id="searchBox" placeholder="æœå°‹æ–‡ç« ...">
      <button onclick="window.location.href='submit.html'">âœï¸ æˆ‘è¦æŠ•ç¨¿</button>
    `;

    for (let region in groups) {
      let h3 = document.createElement("h3");
      h3.innerText = region;
      sidebar.appendChild(h3);

      let ul = document.createElement("ul");
      groups[region].forEach(post => {
        let li = document.createElement("li");
        let a = document.createElement("a");
        a.innerText = post.title;
        a.href = "#";
        a.onclick = () => showPost(post);
        li.appendChild(a);
        ul.appendChild(li);
      });
      sidebar.appendChild(ul);
    }

    document.getElementById("searchBox").addEventListener("input", e => {
      const keyword = e.target.value.toLowerCase();
      const links = sidebar.querySelectorAll("a");
      links.forEach(link => {
        link.style.display = link.innerText.toLowerCase().includes(keyword) ? "block" : "none";
      });
    });
  }

  function renderLatest(posts) {
    posts.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
    const latest = posts.slice(0,3);
    const latestDiv = document.getElementById("latestPosts");
    latestDiv.innerHTML = "";

    latest.forEach(post => {
      let card = document.createElement("div");
      card.className = "postCard";
      card.style.cursor = "pointer";
      card.innerHTML = `
        <h3>${post.title}</h3>
        <p>${(post.content || "").substring(0,100)}...</p>
      `;
      card.onclick = () => showPost(post);
      latestDiv.appendChild(card);
    });
  }

  // æ›´æ–°åœ°åœ–ç¯„åœå…§çš„æ¨™è¨˜
  function updateMarkersByBounds() {
    if (!map.getBounds()) return; // åœ°åœ–å°šæœªåˆå§‹åŒ–å®Œæˆ
    clearMarkers();

    const bounds = map.getBounds();
    allPosts.forEach(post => {
      if (post.coordinates) {
        let pos = new google.maps.LatLng(post.coordinates.latitude, post.coordinates.longitude);
        if (bounds.contains(pos)) {
          addMarker(post);
        }
      }
    });
  }

  function addMarker(post) {
    let pos = {
      lat: post.coordinates.latitude,
      lng: post.coordinates.longitude
    };
    let marker = new google.maps.Marker({
      position: pos,
      map: map,
      title: post.title
    });
    marker.addListener("click", () => {
      showPost(post);
    });
    markers.push(marker);
  }

  function clearMarkers() {
    markers.forEach(m => m.setMap(null));
    markers = [];
  }

  function showPost(post) {
    document.getElementById("postListView").style.display = "none";
    document.getElementById("postDetailView").style.display = "block";
    document.getElementById("currentPostTitle").innerText = post.title;

    const detail = document.getElementById("postDetailContent");
    detail.innerHTML = `
      <div class="postCard">
        <h3>${post.title}</h3>
        <p>${post.content}</p>
        <p><b>åœ°é»ï¼š</b>${post.locationName}</p>
      </div>
    `;

    if (post.coordinates) {
      let pos = {
        lat: post.coordinates.latitude,
        lng: post.coordinates.longitude
      };
      map.setCenter(pos);
      map.setZoom(14);
    } else {
      alert("æ­¤æ–‡ç« å°šæœªæä¾›åº§æ¨™");
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function goBack() {
    document.getElementById("postDetailView").style.display = "none";
    document.getElementById("postListView").style.display = "block";
    document.getElementById("map").scrollIntoView({ behavior: 'smooth' });
  }

  loadPosts();
</script>
</body>
</html>
